# in-16: Persistent Structural Diffing and Grammar Audit Trails

## Problem

Gabion’s structural output (`FactorizationTree`) is ephemeral by default. Once a run completes, the inferred dataflow grammar is discarded unless manually captured. This limits Gabion’s utility in CI workflows, where architectural change detection is crucial, and in long-term refactoring efforts, where tracking grammar evolution across time or commits could surface hidden drift.

Additionally, without a formal diffing mechanism, teams cannot tell whether new grammar violations are regressions or the result of valid structural shifts.

## Goals

* Enable Gabion to persist structural audits as stable digest files (e.g. JSON or hash-based summaries).
* Support diffing between `FactorizationTree` snapshots across runs or commits.
* Flag emerging bundles, tier escalations, or degraded refactor opportunity density.
* Feed snapshot diffs into CI pipelines for regression checks and metrics dashboards.

## Proposed Approach

1. **Emit Canonical `FactorizationTree` Snapshots**

   * Add CLI flag: `--emit-structure-tree=<path>`
   * Format: canonical JSON, stable across version boundaries
   * Optionally include glossary violation context and bundle tier counts

2. **Introduce Structural Digest Comparison CLI**

   * Add CLI command: `gabion diff --baseline path/to/old.json --new path/to/new.json`
   * Output: JSON patch + human-readable summary (e.g. new bundle: `auth_context`, usage depth: 3)

3. **Define Summary Metrics**

   * Total bundle count
   * Mean / max parameter count per bundle
   * Emergent bundle frequency
   * Tier boundary violations
   * Glossary coverage %

4. **CI Integration**

   * Enable `gabion check` to accept `--baseline` and fail on new violations or entropy growth
   * Allow override: `--update-baseline` gated by manual review

## Example

Baseline (main branch):

```json
{
  "bundles": ["user_ctx", "db_config"],
  "violations": [],
  "tier_2_leaks": 0
}
```

Feature branch:

```json
{
  "bundles": ["user_ctx", "db_config", "mode_flags"],
  "violations": ["mode_flags has no glossary entry"],
  "tier_2_leaks": 1
}
```

Gabion emits:

```
✗ New bundle 'mode_flags' introduced without glossary contract
✗ Tier 2 variable appears in leaf function (violates in-15)
✗ CI failure: structural regression
```

## Dependencies

* Stable tree serialization (canonical sort + normalized labels)
* Optional: glossary fingerprinting mechanism

## Acceptance Criteria

* Snapshots emit via CLI with stable format
* `gabion diff` outputs structural delta with bundle-level granularity
* CI integration supports fail-on-new-violation mode with baseline pinning
* Summary metrics exportable for downstream reporting

---

Proposed by: downstream CI audit requirements
Related: in-3 (dataflow bundling), in-15 (tier enforcement)
Status: draft
