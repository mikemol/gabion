---
doc_revision: 2
reader_reintern: Reader-only: re-intern if doc_revision changed since you last read this doc.
doc_id: in_22
doc_role: inbox
doc_scope:
  - repo
  - inbox
doc_authority: informative
doc_owner: maintainer
doc_requires:
  - POLICY_SEED.md#policy_seed
  - glossary.md#contract
doc_reviewed_as_of:
  POLICY_SEED.md#policy_seed: 1
  glossary.md#contract: 1
doc_review_notes:
  POLICY_SEED.md#policy_seed: Revised status/phase framing only; no policy contract changes.
  glossary.md#contract: Updated implementation phases to align with Forest/SuiteSite/hash-consing terminology.
doc_change_protocol: POLICY_SEED.md#change_protocol
doc_erasure:
  - formatting
  - typos
doc_sections:
  in_in_22: 2
doc_section_requires:
  in_in_22:
    - POLICY_SEED.md#policy_seed
    - glossary.md#contract
doc_section_reviews:
  in_in_22:
    POLICY_SEED.md#policy_seed:
      dep_version: 1
      self_version_at_review: 2
      outcome: no_change
      note: Status split does not alter governance obligations.
    glossary.md#contract:
      dep_version: 1
      self_version_at_review: 2
      outcome: no_change
      note: Phase language stays aligned with Forest/SuiteSite/hash-consing semantics.
---

<a id="in_in_22"></a>
# in/in-22.md — ASPF carrier migration status split

## Purpose

This note separates **completed fingerprint mechanics** from **remaining carrier migration work** so implementation planning reflects current module boundaries:

- `src/gabion/analysis/aspf.py` = interned Forest carriers (`NodeId`, `Node`, `Alt`, `Forest`).
- `src/gabion/analysis/type_fingerprints.py` = fingerprint algebra/registry/synthesis mechanics.
- `src/gabion/analysis/dataflow_audit.py` = orchestration, projections, persistence paths, and report emissions.

Normative governance remains in `POLICY_SEED.md#policy_seed`; semantic terms remain governed by `glossary.md#contract` (especially Forest, SuiteSite, and hash-consing/internment).

## Current status

### Completed mechanics (implemented and active)

1. **Core Forest internment exists**
   - `NodeId`, `Node`, `Alt`, and `Forest` are live carriers.
   - Forest insertion is interned by canonical node key and emits relation alts.

2. **Suite locality carriers are present**
   - `SuiteSite` and containment edges are first-class Forest records.
   - Function-level views can be derived from suite-level materialization.

3. **Fingerprint algebra pipeline is in production path**
   - Prime registry, constructor registry, and synth registry plumbing exist.
   - Fingerprint defaults/config parsing and registry loading are wired from audit entrypoints.

4. **Audit integration is real, not speculative**
   - `dataflow_audit.py` initializes and routes fingerprint components.
   - Projection/report outputs already consume fingerprint-derived artifacts.

### Remaining migration (not fully complete)

1. **NodeId/Forest identity migration**
   - Finish migration from legacy ad hoc identifiers to universal Forest `NodeId` identity across all relevant call sites.
   - Remove residual dual-path identity assumptions in downstream projections.

2. **Evidence/Alt interning**
   - Establish deterministic interning/normalization for `Alt.evidence` payloads where currently list-like append semantics remain.
   - Ensure canonicalization rules match glossary erasure constraints (formatting-order differences erased; semantic keys preserved).

3. **Registry seeding strategy**
   - Formalize bootstrap order and persistence behavior for prime/constructor/synth registries.
   - Distinguish immutable seed sets from run-learned extensions and encode upgrade/compat policy.

4. **Stage-cache fingerprint keys**
   - Standardize stage cache keys so fingerprint-bearing stages are keyed by canonical fingerprint identity instead of mixed local tuples.
   - Prevent cache misses from equivalent-but-differently-serialized key fragments.

5. **Reverse-map performance strategy (sidecar/exponent-vector)**
   - Introduce a sidecar reverse-map index (or exponent-vector equivalent) for divisibility/containment queries.
   - Keep this an optimization layer over canonical interned carriers, not a second semantic source.

## Phase plan (mapped to code ownership)

### Phase A — Stabilize identity carriers (owner: `aspf.py`)

- Complete NodeId-first identity on all new/updated edges.
- Ensure `Forest` remains the single semantic internment surface.
- Confirm SuiteSite attachment rules remain local-first (function-level as projection).

### Phase B — Canonicalize fingerprint transport (owner: `type_fingerprints.py`)

- Freeze registry seeding contract (seeded vs learned entries).
- Define canonical fingerprint/stage-key representation for cross-stage cache reuse.
- Prepare reverse lookup sidecar schema compatible with existing fingerprint algebra.

### Phase C — Migrate orchestration and persistence (owner: `dataflow_audit.py`)

- Route stage caches to canonical fingerprint keys.
- Wire reverse-map sidecar lifecycle (build/load/emit) without altering core semantics.
- Keep current report outputs stable while internals migrate.

### Phase D — De-risk and retire legacy paths (cross-module)

- Remove residual legacy keying/identity branches after parity verification.
- Keep equivalence tests focused on semantic commutation, not serialization artifacts.

## Acceptance criteria for migration completion

- No production path depends on non-`NodeId` identity for Forest entities.
- `Alt` evidence canonicalization yields deterministic replay across re-audits.
- Registry seeding is documented and reproducible from config + seed artifacts.
- Stage caches hit on semantically equivalent fingerprints across runs.
- Reverse-map sidecar/exponent-vector path improves lookup cost without changing results.

## Notes on normative alignment

- This document is implementation-status guidance only; it does not override policy.
- If any proposed migration step conflicts with `POLICY_SEED.md#policy_seed`, policy wins.
- Terminology for Forest/SuiteSite/hash-consing remains aligned with `glossary.md#contract`.
