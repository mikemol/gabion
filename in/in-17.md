# in-17: Subtree Reuse Detection and Lemma Synthesis Hooks

## Problem

Gabion emits full `FactorizationTree` structures but currently lacks support for factoring out repeated subtrees or identifying structural fragments that would benefit from reuse. This limits its ability to surface redundant constructions in code, discourage deep copy-paste proliferation, or suggest intermediate abstractions (e.g. helper functions or reusable lemmas in proof systems).

Without subtree analysis, developers must manually detect that the same parameter bundle or structural motif appears across multiple call paths or contexts, despite Gabion already having full visibility over the factorization tree.

## Goals

* Detect and group isomorphic subtrees across a `FactorizationTree`.
* Assign symbolic names to common subtrees (e.g. `_lemma_1`), optionally annotated with suggested glossary roles.
* Enable rewrite synthesis to lift shared structures into reusable function/lemma definitions.
* Support a lightweight `--suggest-lemmas` mode for both Python and Agda output.

## Proposed Approach

1. **Tree Fingerprinting Pass**

   * Walk the factorization tree and assign a canonical structural hash to each node.
   * Group nodes by identical hash and compatible shape.
   * Track frequency and callsite origin for each group.

2. **Threshold-Based Lemma Suggestion**

   * If a subtree appears in more than N locations (default: 2), emit a synthetic name (e.g. `_gabion_subtree_1`).
   * Generate code block in Agda or Python: a function or lemma definition corresponding to the subtree body.
   * Replace original tree node with a reference to the synthesized name.

3. **Glossary Integration (Optional)**

   * When a detected subtree matches a glossary-named concept (e.g. "auth_bundle"), prefer that name.
   * If it does not match any glossary key, emit with a `Missing glossary entry: suggested name` warning.

4. **CLI Flag and Output Format**

   * `--suggest-lemmas`: activates lemma candidate detection
   * Output format includes synthetic subtree declarations and replacement map
   * Option to emit as standalone module stub or inline near use site

## Example

Before:

```agda
leaf (log_config)
node (log_context) (
  leaf (log_config)
  leaf (log_level)
)
```

After:

```agda
logBase : FactorizationTree T
logBase = node "log_context" (
  leaf "log_config"
  leaf "log_level"
)

...
logBase
...
logBase
```

Gabion emits:

```
✓ Repeated structure (3x) detected for bundle: [log_config, log_level]
✓ Suggest declaring reusable subtree: `logBase`
✓ Glossary match: none — consider adding glossary entry
```

## Dependencies

* Requires subtree hashing for structural identity
* Optional: integration with glossary auto-suggestion and tier metadata
* Leverages existing Agda/Python emitters for function definition rendering

## Acceptance Criteria

* Lemma suggestion mode emits at least one deduplicated subtree on real example
* CLI option outputs synthetic lemma + reference rewrites
* Structural footprint of emitted trees is reduced
* Optional glossary crosslink suggested for top subtree names

---

Proposed by: grammar synthesis team
Related: in-3 (bundle identification), in-15 (tier boundary elevation), in-16 (diffing)
Status: draft
