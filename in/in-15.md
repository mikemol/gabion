# in-15: Contextual Rewriting and Decision Surface Elevation

## Problem

Gabion's grammar engine identifies bundled parameters that propagate through call graphs, and supports their refactoring into explicit structures. However, it currently lacks a formal mechanism to (a) determine when a bundle should be rewritten into ambient or managed context, and (b) detect and elevate decision points to semantically appropriate boundaries (e.g. API layers).

Without such mechanisms, context propagation remains strictly structural, and refactors cannot align architectural complexity with glossary-defined semantic tiers.

## Goals

* Enable Gabion to refactor bundles into implicit context via `contextvars`, `contextlib`, or similar.
* Allow grammars to annotate which parameters represent *decision surfaces* (i.e. inputs that bifurcate behavior).
* Provide diagnostics when tier-2 or tier-3 decision variables are embedded too deep in function internals.
* Establish a path for glossary-tier-driven enforcement of semantic boundaries.

## Proposed Approach

1. **Extend `PartitionGrammar` with Optional Rewriting Hints**

   * Add method `should_hoist_to_context(self, obj: T) -> bool`
   * Add method `is_decision_surface(self, obj: T) -> bool`
   * These return advisory flags for context rewriting and boundary elevation.

2. **Annotate Glossary Entries with Tier Metadata**

   * Each glossary term may include `tier: 0 | 1 | 2 | 3`
   * During audit, Gabion checks whether parameters or bundles violate their permitted scope (e.g. a tier-2 identifier used below an API boundary).

3. **Enable Rewriter Mode**

   * Extend the synthesis engine to optionally emit `contextvars.ContextVar` assignments and accessors.
   * Modify callsite generation to prefer ambient access over parameter passing where flagged.

4. **Add CI-Lint Rule**

   * If decision surfaces are detected below their permitted tier (per glossary), emit a violation.

## Example

Glossary:

```toml
[user_mode]
tier = 2
```

Python code:

```python
def internal_handler(user_mode, account_id):
    if user_mode == "admin":
        ...
```

Gabion emits:

```
Violation: parameter 'user_mode' is a tier-2 decision surface used below boundary scope. Suggest lifting to API surface or injecting via context.
```

## Open Questions

* Should ambient context insertion be applied automatically or only suggested?
* How should this interact with existing `baseline` mechanisms in CI?

## Dependencies

* Requires grammar support for annotating `is_decision_surface`
* Requires glossary parsing with tier enforcement
* Optional: contextual rewriter module for Python (`contextvars` + callsite rewrite)

## Acceptance Criteria

* At least one grammar defines and respects decision surfaces
* Glossary tier audit passes on core grammar examples
* Refactor output shows correct `contextvar` promotion for at least one bundle
* CI failure occurs on glossary-tier violation

---

Proposed by: internal grammar audit
Related: in-3 (bundle propagation), in-6 (refactor constraints)
Status: draft
