---
doc_revision: 1
reader_reintern: Reader-only: re-intern if doc_revision changed since you last read this doc.
doc_id: in_15
doc_role: inbox
doc_scope:
  - repo
  - inbox
doc_authority: informative
doc_owner: maintainer
doc_requires:
  - POLICY_SEED.md#policy_seed
  - glossary.md#decision_surface
  - glossary.md#tier
  - glossary.md#decision_table
  - glossary.md#decision_bundle
  - glossary.md#decision_protocol
  - README.md#repo_contract
  - CONTRIBUTING.md#contributing_contract
  - AGENTS.md#agent_obligations
doc_reviewed_as_of:
  POLICY_SEED.md#policy_seed: 1
  glossary.md#decision_surface: 1
  glossary.md#tier: 1
  glossary.md#decision_table: 1
  glossary.md#decision_bundle: 1
  glossary.md#decision_protocol: 1
  README.md#repo_contract: 1
  CONTRIBUTING.md#contributing_contract: 1
  AGENTS.md#agent_obligations: 1
doc_review_notes:
  POLICY_SEED.md#policy_seed: Reviewed POLICY_SEED.md rev1 (mechanized governance default; branch/tag CAS + check-before-use constraints); no conflicts with this document's scope.
  glossary.md#decision_surface: Reviewed glossary.md#decision_surface rev1 (decision surface tier boundary semantics).
  glossary.md#tier: Reviewed glossary.md#tier rev1 (tier evidence thresholds + promotion requirements).
  glossary.md#decision_table: Reviewed glossary.md#decision_table rev1 (decision table tier definition).
  glossary.md#decision_bundle: Reviewed glossary.md#decision_bundle rev1 (decision bundle tier definition).
  glossary.md#decision_protocol: Reviewed glossary.md#decision_protocol rev1 (decision protocol tier definition).
  README.md#repo_contract: Reviewed README.md rev1 (docflow audit now scans in/ by default); no conflicts with this document's scope.
  CONTRIBUTING.md#contributing_contract: Reviewed CONTRIBUTING.md rev1 (docflow now fails on missing GH references for SPPF-relevant changes); no conflicts with this document's scope.
  AGENTS.md#agent_obligations: Agent obligations unchanged; decision-surface enforcement aligns with glossary tiers.
doc_change_protocol: POLICY_SEED.md#change_protocol
doc_erasure:
  - formatting
  - typos
doc_sections:
  in_in_15: 1
doc_section_requires:
  in_in_15:
    - POLICY_SEED.md#policy_seed
    - glossary.md#decision_surface
    - glossary.md#tier
    - glossary.md#decision_table
    - glossary.md#decision_bundle
    - glossary.md#decision_protocol
    - README.md#repo_contract
    - CONTRIBUTING.md#contributing_contract
    - AGENTS.md#agent_obligations
doc_section_reviews:
  in_in_15:
    POLICY_SEED.md#policy_seed:
      dep_version: 1
      self_version_at_review: 1
      outcome: no_change
      note: Reviewed POLICY_SEED.md rev1 (mechanized governance default; branch/tag CAS + check-before-use constraints); no conflicts with this document's scope.
    glossary.md#decision_surface:
      dep_version: 1
      self_version_at_review: 1
      outcome: no_change
      note: Reviewed glossary.md#decision_surface rev1 (decision surface tier boundary semantics).
    glossary.md#tier:
      dep_version: 1
      self_version_at_review: 1
      outcome: no_change
      note: Reviewed glossary.md#tier rev1 (tier evidence thresholds + promotion requirements).
    glossary.md#decision_table:
      dep_version: 1
      self_version_at_review: 1
      outcome: no_change
      note: Reviewed glossary.md#decision_table rev1 (decision table tier definition).
    glossary.md#decision_bundle:
      dep_version: 1
      self_version_at_review: 1
      outcome: no_change
      note: Reviewed glossary.md#decision_bundle rev1 (decision bundle tier definition).
    glossary.md#decision_protocol:
      dep_version: 1
      self_version_at_review: 1
      outcome: no_change
      note: Reviewed glossary.md#decision_protocol rev1 (decision protocol tier definition).
    README.md#repo_contract:
      dep_version: 1
      self_version_at_review: 1
      outcome: no_change
      note: Reviewed README.md rev1 (docflow audit now scans in/ by default); no conflicts with this document's scope.
    CONTRIBUTING.md#contributing_contract:
      dep_version: 1
      self_version_at_review: 1
      outcome: no_change
      note: Reviewed CONTRIBUTING.md rev1 (docflow now fails on missing GH references for SPPF-relevant changes); no conflicts with this document's scope.
    AGENTS.md#agent_obligations:
      dep_version: 1
      self_version_at_review: 1
      outcome: no_change
      note: Agent obligations unchanged; decision-surface enforcement aligns with glossary tiers.
---

<a id="in_in_15"></a>

# in-15: Contextual Rewriting and Decision Surface Elevation

## Problem

Gabion's grammar engine identifies bundled parameters that propagate through call graphs, and supports their refactoring into explicit structures. However, it currently lacks a formal mechanism to (a) determine when a bundle should be rewritten into ambient or managed context, and (b) detect and elevate decision points to semantically appropriate boundaries (e.g. API layers).

Without such mechanisms, context propagation remains strictly structural, and refactors cannot align architectural complexity with glossary-defined semantic tiers.

Normative pointers (explicit): [POLICY_SEED.md#policy_seed](POLICY_SEED.md#policy_seed), [glossary.md#decision_surface](glossary.md#decision_surface), [glossary.md#tier](glossary.md#tier),
[glossary.md#decision_table](glossary.md#decision_table), [glossary.md#decision_bundle](glossary.md#decision_bundle), [glossary.md#decision_protocol](glossary.md#decision_protocol),
[README.md#repo_contract](README.md#repo_contract), [CONTRIBUTING.md#contributing_contract](CONTRIBUTING.md#contributing_contract), [AGENTS.md#agent_obligations](AGENTS.md#agent_obligations).

## Goals

* Enable Gabion to refactor bundles into implicit context via `contextvars`, `contextlib`, or similar.
* Allow grammars to annotate which parameters represent *decision surfaces* (i.e. inputs that bifurcate behavior).
* Provide diagnostics when tier-2 or tier-3 decision variables are embedded too deep in function internals.
* Establish a path for glossary-tier-driven enforcement of semantic boundaries.

## Proposed Approach

1. **Extend `PartitionGrammar` with Optional Rewriting Hints**

   * Add method `should_hoist_to_context(self, obj: T) -> bool`
   * Add method `is_decision_surface(self, obj: T) -> bool`
   * These return advisory flags for context rewriting and boundary elevation.

2. **Annotate Glossary Entries with Tier Metadata**

   * Each glossary term may include `tier: 0 | 1 | 2 | 3`
   * During audit, Gabion checks whether parameters or bundles violate their permitted scope (e.g. a tier-2 identifier used below an API boundary).

3. **Enable Rewriter Mode**

   * Extend the synthesis engine to optionally emit `contextvars.ContextVar` assignments and accessors.
   * Modify callsite generation to prefer ambient access over parameter passing where flagged.

4. **Add CI-Lint Rule**

   * If decision surfaces are detected below their permitted tier (per glossary), emit a violation.

## Example

Glossary:

```toml
[user_mode]
tier = 2
```

Python code:

```python
def internal_handler(user_mode, account_id):
    if user_mode == "admin":
        ...
```

Gabion emits:

```
Violation: parameter 'user_mode' is a tier-2 decision surface used below boundary scope. Suggest lifting to API surface or injecting via context.
```

## Open Questions

* Should ambient context insertion be applied automatically or only suggested?
* How should this interact with existing `baseline` mechanisms in CI?

## Dependencies

* Requires grammar support for annotating `is_decision_surface`
* Requires glossary parsing with tier enforcement
* Optional: contextual rewriter module for Python (`contextvars` + callsite rewrite)

## Acceptance Criteria

* At least one grammar defines and respects decision surfaces
* Glossary tier audit passes on core grammar examples
* Refactor output shows correct `contextvar` promotion for at least one bundle
* CI failure occurs on glossary-tier violation

---

Proposed by: internal grammar audit
Related: in-3 (bundle propagation), in-6 (refactor constraints)
Status: draft