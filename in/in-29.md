---
doc_revision: 2
reader_reintern: "Reader-only: re-intern if doc_revision changed since you last read this doc."

doc_id: in-29
doc_role: in_step
doc_scope:
  - repo
  - tooling
  - semantics
  - tests

doc_authority: normative
doc_owner: maintainer

doc_requires:
  - POLICY_SEED.md
  - glossary.md
  - in/in-23.md
  - in/in-24.md
  - in/in-25.md
  - in/in-26.md
  - in/in-27.md
  - in/in-28.md

doc_reviewed_as_of:
  POLICY_SEED.md: 29
  glossary.md: 22
  in/in-23.md: 1
  in/in-24.md: 3
  in/in-25.md: 3
  in/in-26.md: 3
  in/in-27.md: 1
  in/in-28.md: 2
doc_review_notes:
  POLICY_SEED.md: "Evidence-first dominance aligns with review discipline and change-control policy."
  glossary.md: "Evidence surface/dominance terms are scoped; no semantic conflicts."
  in/in-23.md: "Evidence artifacts extend carrier/provenance posture without conflicts."
  in/in-24.md: "Deadness evidence remains orthogonal; no conflicts."
  in/in-25.md: "Coherence evidence unaffected; dominance uses separate axis."
  in/in-26.md: "Refactor obligations can consume evidence artifacts; no conflicts."
  in/in-27.md: "Exception-safety obligations unaffected by test evidence mapping."
  in/in-28.md: "Conforms to in_step template; structure enforced."

doc_change_protocol: "POLICY_SEED.md §6"
doc_erasure:
  - "spelling/formatting only"
  - "reflow without semantic edits"
  - "comment-only changes"
---

# in/in-29.md
## Obsolete-Test Identification via Evidence-First Dominance

### Purpose
This step installs an **evidence-first method** for identifying **obsolete test candidates**: tests that can be removed (or merged) **without shrinking the evidence surface**. The method treats line/branch novelty as secondary signals and requires explicit, machine-readable linkage between tests and the obligations they discharge.

### Non-goals
- This step does **not** automatically delete tests.
- This step does **not** require perfect semantic inference from code behavior.
- This step does **not** replace functional correctness testing; it adds *coverage semantics*.
- This step does **not** mandate full annotation of all existing tests on day one.

---

## Status
- **This step installs:** a test→evidence mapping regime + dominance analysis + obsolescence reporting artifacts.
- **This step depends on:** the repo’s evidence/witness posture (policy + `in-23`–`in-27`) and the `in_step` structure (`in-28`).
- **This step unblocks:** systematic reduction/merging of redundant tests; “branch-irrelevance” detection; ratcheted semantic coverage.
- **Failure mode if absent:** test suite grows by branch/line chasing, with unclear semantic contribution; reviewers cannot reliably identify redundancy.

---

## Definitions

- **Evidence ID:** A stable identifier naming an obligation/invariant/lemma a test discharges (e.g., `INVARIANT.rename_morphism_preserved`).
- **Evidence surface:** The set of all Evidence IDs discharged by the test suite.
- **Dominance:** A partial order where one test’s discharged obligations (and optionally behavior coverage) subsume another’s.
- **Obsolete candidate:** A test dominated by others such that its removal does not shrink the evidence surface, subject to risk guardrails.
- **Branch-irrelevance smell:** A test that increases line/branch coverage without adding evidence (i.e., executes but proves nothing new).

---

## Face / Kit / Solver

### Face (Obligations)

- **F1 (Evidence linkage):** Each test shall be attributable to one or more **Evidence IDs**, or explicitly marked as **untagged/unknown**.
  - **Witness hook:** `out/test_evidence.json` + unmapped test list.
- **F2 (Evidence-first obsolescence):** “Obsolete candidate” classification shall be computed primarily from **evidence dominance**, not line/branch novelty.
  - **Witness hook:** `out/test_obsolescence_report.json` with dominance reasons.
- **F3 (Smell visibility):** The system shall report **branch-irrelevance smell**: tests that add branch/line deltas but no evidence.
  - **Witness hook:** report section + JSON fields enumerating these tests.
- **F4 (Guardrails):** The system shall prevent classification that would remove the **last** test covering any **high-risk** evidence.
  - **Witness hook:** `out/evidence_risk_registry.json` + guardrail checks in audit.
- **F5 (Ratcheting option):** The repo may ratchet toward completeness by enforcing monotonic growth of the evidence surface (optional gate).
  - **Witness hook:** baseline artifact + CI rule (configurable).

### Kit (Existing machinery)

- **Normative evidence posture:** Evidence/witness vocabulary and ratchet philosophy from `POLICY_SEED.md` and the `in-23`–`in-27` series.
- **Artifact discipline:** `in-23+` pattern of producer/consumer/schema/determinism.
- **CI substrate:** Existing pipeline that can run scripts and audits and publish artifacts.
- **Test harness:** Existing test runner (assumed pytest unless otherwise specified) and ability to incorporate coverage tooling.

### Solver (Implementation plan)

1. **Standardize Evidence ID declaration in tests**
   - Allowed mechanisms (at least one must be supported):
     - Inline marker comment: `# EVIDENCE: <EVIDENCE_ID>`
     - Helper call: `evidence("<EVIDENCE_ID>")`
     - Decorator: `@evidences("<EVIDENCE_ID>", ...)`
   - Initial adoption may be partial; unmapped tests remain reportable.

2. **Emit evidence mapping artifact**
   - Script extracts test identifiers and Evidence IDs.
   - Produces `out/test_evidence.json`.

3. **Emit per-test behavioral deltas (secondary signals)**
   - Collect per-test branch and line coverage (prefer branch).
   - Produce `out/test_branch_coverage.json` and `out/test_line_coverage.json`.

4. **Compute dominance and obsolescence candidates**
   - Evidence-dominance: test A dominates B if `E(B) ⊆ E(A)`.
   - Behavioral-dominance (optional refinement): branch/line deltas as tie-breakers.
   - Produce `out/test_obsolescence_report.json` + markdown summary.

5. **Apply guardrails**
   - If removing B would eliminate coverage of a `high` risk evidence ID, B is not classified obsolete.
   - Risk registry provides the authoritative risk level.

6. **Integrate audits**
   - A Gabion-shaped audit reads artifacts and enforces:
     - schema validity
     - determinism (stable ordering)
     - guardrails
     - optional ratchet rules
   - CI publishes the report and optionally blocks merges on configured failure classes.

---

## Artifact Contract

### Required artifacts

#### `out/test_evidence.json`
- **Producer:** `scripts/extract_test_evidence.py` (or equivalent)
- **Consumer:** `scripts/analyze_test_dominance.py` + audit
- **Schema:**
  - `version: int`
  - `basis: { repo_rev: str, tool_versions: {...} }`
  - `tests: { "<test_id>": { "evidence": [str], "status": "mapped"|"unmapped" } }`
  - `evidence_index: { "<evidence_id>": ["<test_id>", ...] }`
- **Determinism:** stable ordering by `test_id` and lexicographic evidence lists
- **Update rule:** additive; reclassification requires `doc_revision` bump to this step if semantics change

#### `out/test_branch_coverage.json`
- **Producer:** `scripts/collect_test_coverage.py --branches`
- **Consumer:** dominance analysis + audit
- **Schema:**
  - `version: int`
  - `tests: { "<test_id>": { "branches": [ "<file>:<arc>", ... ] } }`
- **Determinism:** stable ordering; canonical arc encoding

#### `out/test_line_coverage.json`
- **Producer:** `scripts/collect_test_coverage.py --lines`
- **Consumer:** dominance analysis + audit
- **Schema:**
  - `version: int`
  - `tests: { "<test_id>": { "lines": [ "<file>:<lineno>", ... ] } }`

#### `out/evidence_risk_registry.json`
- **Producer:** human-maintained (reviewed)
- **Consumer:** dominance analysis + audit guardrails
- **Schema:**
  - `version: int`
  - `evidence: { "<evidence_id>": { "risk": "low"|"med"|"high", "owner": str, "rationale": str } }`
- **Determinism:** stable ordering by `evidence_id`
- **Update rule:** review-required; changes treated as semantic

#### `out/test_obsolescence_report.json`
- **Producer:** `scripts/analyze_test_dominance.py`
- **Consumer:** CI/reporting + optional gating audit
- **Schema:**
  - `version: int`
  - `candidates: [ { "test_id": str,
                    "class": "obsolete_candidate"|"redundant_by_evidence"|"behavior_unique_no_evidence"|"unmapped",
                    "reason": { "evidence": {...}, "branches": {...}, "lines": {...}, "guardrails": {...} },
                    "dominators": [str] } ]`
  - `summary: { counts... }`
- **Determinism:** stable ordering by `class` then `test_id`

#### `out/test_obsolescence_report.md`
- Human-readable companion to the JSON, suitable for PR artifacts.

### Provenance
Each emitted artifact shall record:
- repo revision / commit hash
- tool versions (python, coverage tool version, etc.)
- configuration knobs (e.g., dominance thresholds, branch-vs-line preference)

“Latest” is never implicit; report corresponds to an explicit basis.

---

## Admissibility

- **Admissible:**
  - Introducing Evidence IDs and mapping tests to them.
  - Merging redundant tests into parameterized forms if evidence coverage is preserved.
  - Removing tests classified as obsolete candidates **after review**.
- **Inadmissible:**
  - Treating line/branch novelty as sufficient evidence of value.
  - Removing the last test covering a `high` risk evidence ID.
  - Allowing new tests to land without either evidence mapping or explicit “unmapped” accounting (policy-configurable).
- **Ambiguity policy:** unmapped tests are allowed but surfaced; classification is conservative when evidence intent is unknown.
- **Non-explosion policy:** contradictions (e.g., evidence tags not in registry, inconsistent IDs) are reported and fail audits rather than silently normalized.

---

## Checks as Lemmas

- **Lemma L1 (discharges F1):** extraction script produces `test_evidence.json` and lists unmapped tests.
- **Lemma L2 (discharges F2):** dominance analysis computes evidence dominance and emits candidate classes.
- **Lemma L3 (discharges F3):** report highlights branch/line-only contributions without evidence.
- **Lemma L4 (discharges F4):** guardrail check prevents “last high-risk coverage” removal classification.
- **Lemma L5 (discharges F5, optional):** ratchet gate asserts evidence surface does not shrink vs baseline.

---

## Success Criteria

- [ ] A report is produced on CI for every PR, listing unmapped tests and redundancy classes.
- [ ] A dominated test can be identified with explicit dominators and a machine-checkable reason.
- [ ] High-risk evidence cannot become uncovered without explicit audit failure.
- [ ] The repo can choose (by configuration) whether to enforce “no new unmapped tests.”

---

## Failure Modes and Diagnostics

- **FM1:** Evidence tags malformed/unknown → inspect `test_evidence.json` extraction warnings; check Evidence ID naming.
- **FM2:** Dominance report unstable across runs → check determinism rules (ordering, canonical arc encoding).
- **FM3:** Too many “unmapped” tests → adopt gradual tagging: require mapping only for new/modified tests first.
- **FM4:** Branch coverage noisy (e.g., debug/log) → rely on evidence-first classification; branch novelty remains secondary.
- **FM5:** Guardrail blocks many deletions → adjust risk registry (overuse of `high`) or split evidence IDs more granularly.

---

## Commands

```bash
# 1) Extract test evidence (tags/decorators/helpers)
python -m scripts.extract_test_evidence --tests tests/ --out out/test_evidence.json

# 2) Collect per-test coverage (prefer branches)
python -m scripts.collect_test_coverage --tests tests/ --branches --out out/test_branch_coverage.json
python -m scripts.collect_test_coverage --tests tests/ --lines --out out/test_line_coverage.json

# 3) Analyze dominance and produce report artifacts
python -m scripts.analyze_test_dominance \
  --evidence out/test_evidence.json \
  --branches out/test_branch_coverage.json \
  --lines out/test_line_coverage.json \
  --risk out/evidence_risk_registry.json \
  --out-json out/test_obsolescence_report.json \
  --out-md out/test_obsolescence_report.md
```

---

## Appendix A: Canonical Template (Authoritative)

This document conforms to the canonical `in_step` template defined in `in/in-28.md`.
That template remains authoritative for structure, required sections, and frontmatter.

## Appendix B: Structural self-audit

### Notion registry

1. Evidence ID
2. Evidence surface
3. Dominance
4. Obsolete candidate
5. Branch-irrelevance smell
6. Risk guardrail
7. Ratchet gate
8. Report artifacts

### H₀–H₃ organizational interpretation

* **H₀:** A reportable mapping from tests to named obligations.
* **H₁:** Dominance as a dependency graph over tests via evidence inclusion.
* **H₂:** Guardrails as a cohomology-like obstruction: “cannot remove last high-risk witness.”
* **H₃:** The test suite as a semantic basis whose generators (tests) can be minimized without losing obligations.

### 3×3×3 orthogonal implication braid (compressed)

* **(Evidence × Behavior × Risk)**

  * Evidence dominates behavior; risk constrains removals.
* **(Artifacts × Audits × Gates)**

  * Artifacts carry claims; audits validate; gates enforce (optionally).
* **(Human intent × Machine extraction × Review)**

  * Intent is named (Evidence IDs), extraction is deterministic, review decides action.

---

## Appendix C: Evidence ID conventions (recommended)

* Namespace prefixes:

  * `INVARIANT.*` (semantic properties)
  * `RULE.*` (rule instantiations / transformations)
  * `FAILURE.*` (failure classifications)
  * `EDGE.*` (edge-case classes; optional)
* IDs are stable; rename only with a migration note and `doc_revision` bump if semantics change.
