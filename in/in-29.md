---
doc_revision: 9
reader_reintern: "Reader-only: re-intern if doc_revision changed since you last read this doc."

doc_id: in-29
doc_role: in_step
doc_scope:
  - repo
  - tooling
  - semantics
  - tests

doc_authority: normative
doc_owner: maintainer

doc_requires:
  - POLICY_SEED.md
  - glossary.md
  - in/in-23.md
  - in/in-24.md
  - in/in-25.md
  - in/in-26.md
  - in/in-27.md
  - in/in-28.md

doc_reviewed_as_of:
  POLICY_SEED.md: 29
  glossary.md: 26
  in/in-23.md: 1
  in/in-24.md: 3
  in/in-25.md: 3
  in/in-26.md: 3
  in/in-27.md: 1
  in/in-28.md: 2
doc_review_notes:
  POLICY_SEED.md: "Evidence-first dominance aligns with review discipline and change-control policy."
  glossary.md: "Reviewed glossary update (call_footprint evidence key); evidence-first semantics align."
  in/in-23.md: "Evidence artifacts extend carrier/provenance posture without conflicts."
  in/in-24.md: "Deadness evidence remains orthogonal; no conflicts."
  in/in-25.md: "Coherence evidence unaffected; dominance uses separate axis."
  in/in-26.md: "Refactor obligations can consume evidence artifacts; no conflicts."
  in/in-27.md: "Exception-safety obligations unaffected by test evidence mapping."
  in/in-28.md: "Conforms to in_step template; structure enforced."

doc_change_protocol: "POLICY_SEED.md §6"
doc_erasure:
  - "spelling/formatting only"
  - "reflow without semantic edits"
  - "comment-only changes"
---

# in/in-29.md
## Obsolete-Test Identification via Evidence-First Dominance

### Purpose
This step installs an **evidence-first method** for identifying **obsolete test candidates**: tests that can be removed (or merged) **without shrinking the evidence surface**. The method treats line/branch novelty as secondary signals and requires explicit, machine-readable linkage between tests and the obligations they discharge.

### Non-goals
- This step does **not** automatically delete tests.
- This step does **not** require perfect semantic inference from code behavior.
- This step does **not** replace functional correctness testing; it adds *coverage semantics*.
- This step does **not** mandate full annotation of all existing tests on day one.

---

## Status
- **This step installs:** a test→evidence mapping regime + dominance analysis + obsolescence reporting artifacts.
- **This step depends on:** the repo’s evidence/witness posture (policy + `in-23`–`in-27`) and the `in_step` structure (`in-28`).
- **This step unblocks:** systematic reduction/merging of redundant tests; “branch-irrelevance” detection; ratcheted semantic coverage.
- **Failure mode if absent:** test suite grows by branch/line chasing, with unclear semantic contribution; reviewers cannot reliably identify redundancy.

---

## Definitions

- **Evidence ID:** A stable identifier naming an obligation/invariant/lemma a test discharges (e.g., `E:bundle/alias_invariance`).
- **Evidence Key:** Canonical, graph-derived identity for evidence (stored in artifacts as structured data; `display` is presentation).
- **Evidence surface:** The set of all Evidence IDs discharged by the test suite.
- **Strict dominance (redundancy):** Test A strictly dominates B iff `E(B) ⊂ E(A)` (proper subset).
- **Equivalent witness:** Tests with identical evidence sets (`E(A) = E(B)`); not redundant by evidence alone.
- **Obsolete candidate:** A mapped test that is neither strictly dominated nor blocked by guardrails; additional signals may refine this later.
- **Branch-irrelevance smell:** A test that increases line/branch coverage without adding evidence (future signal; not yet enforced).

---

## Face / Kit / Solver

### Face (Obligations)

- **F1 (Evidence linkage):** Each test shall be attributable to one or more **Evidence IDs**, or explicitly marked as **untagged/unknown**.
  - **Witness hook:** `out/test_evidence.json` + unmapped test list.
- **F2 (Evidence-first obsolescence):** “Obsolete candidate” classification shall be computed primarily from **evidence dominance**, not line/branch novelty.
  - **Witness hook:** `out/test_obsolescence_report.json` with dominance reasons.
- **F3 (Smell visibility, future):** The system should report **branch-irrelevance smell**: tests that add branch/line deltas but no evidence.
  - **Witness hook:** report section + JSON fields enumerating these tests (not yet implemented).
- **F4 (Guardrails):** The system shall prevent classification that would remove the **last** test covering any **high-risk** evidence.
  - **Witness hook:** `out/evidence_risk_registry.json` + guardrail checks in audit.
- **F5 (Ratcheting option):** The repo may ratchet toward completeness by enforcing monotonic growth of the evidence surface (optional gate).
  - **Witness hook:** baseline artifact + CI rule (configurable).

### Kit (Existing machinery)

- **Normative evidence posture:** Evidence/witness vocabulary and ratchet philosophy from `POLICY_SEED.md` and the `in-23`–`in-27` series.
- **Artifact discipline:** `in-23+` pattern of producer/consumer/schema/determinism.
- **CI substrate:** Existing pipeline that can run scripts and audits and publish artifacts.
- **Test harness:** Existing test runner (assumed pytest unless otherwise specified) and ability to incorporate coverage tooling.

### Solver (Implementation plan)

1. **Standardize Evidence ID declaration in tests**
   - **Implemented mechanism:** inline marker comment `# gabion:evidence <EVIDENCE_ID> ...`.
   - Other helper/decorator mechanisms are optional future extensions and are **not** implemented yet.
   - Initial adoption may be partial; unmapped tests remain reportable.
   - EvidenceKey kinds currently emitted include: `paramset`, `decision_surface`, `never_sink`, `function_site`.

2. **Emit evidence mapping artifact**
   - The extractor reads tests and Evidence IDs.
   - Produces `out/test_evidence.json`.

3. **Compute evidence-first dominance and obsolescence candidates**
   - Strict dominance: test A strictly dominates B iff `E(B) ⊂ E(A)`.
   - Equal evidence sets are classified as `equivalent_witness`.
   - Dominance uses **EvidenceKey** identity; display strings are presentation only.
   - Produce `out/test_obsolescence_report.json` + markdown summary.

4. **Emit projections via the canonical front door**
   - `gabion check --emit-test-obsolescence` writes obsolescence reports.
   - `gabion check --emit-test-obsolescence-delta` writes obsolescence delta reports.
   - `gabion check --emit-test-evidence-suggestions` writes evidence suggestions.
   - `gabion check --write-test-obsolescence-baseline` writes the baseline for deltas.
   - Projections read the **existing carrier** `out/test_evidence.json` and the forest.

5. **Apply guardrails**
   - If removing B would eliminate coverage of a `high` risk evidence ID, B is not classified redundant.
   - Risk registry provides the authoritative risk level.

6. **Future/optional behavioral deltas**
   - Per-test branch/line coverage remains a secondary signal and is not yet required.
   - If added, it must not override evidence-first dominance.

---

## Artifact Contract

### Required artifacts

#### `out/test_evidence.json`
- **Producer:** `scripts/extract_test_evidence.py`
- **Consumer:** projections (`gabion check --emit-test-obsolescence`, `--emit-test-evidence-suggestions`)
- **Schema (current):**
  - `schema_version: 2`
  - `scope: { "root": ".", "include": [...], "exclude": [...] }`
  - `tests: [ { "test_id": str, "file": str, "line": int, "status": "mapped"|"unmapped", "evidence": [ { "key": { ...EvidenceKey... }, "display": str } ] } ]`
  - `evidence_index: [ { "key": { ...EvidenceKey... }, "display": str, "tests": [str, ...] } ]`
- **Determinism:** tests sorted by `test_id`; evidence entries sorted by key identity; `evidence_index` sorted by key identity.

#### `out/test_evidence_suggestions.json`
- **Producer:** `gabion check --emit-test-evidence-suggestions`
- **Consumer:** human review + manual tagging PRs (no auto-apply)
- **Schema (current):**
  - `version: 4`
  - `summary: { total, suggested, suggested_graph, suggested_heuristic, skipped_mapped, skipped_no_match, graph_unresolved }`
  - `unmapped_modules: [ { "module": str, "count": int } ]`
  - `unmapped_prefixes: [ { "prefix": str, "count": int } ]`
  - `suggestions: [ { "test_id": str, "file": str, "line": int, "suggested": [ { "key": { ...EvidenceKey... }, "display": str } ], "matched": [str], "source": "graph"|"graph.call_footprint_fallback"|"heuristic", "derived_from"?: [ { "path": str, "qual": str } ] } ]`
- **Determinism:** sorted by `test_id`; evidence entries sorted by key identity.

#### `out/test_evidence_suggestions.md`
- Human-readable companion to the JSON, grouped deterministically.

#### `out/evidence_risk_registry.json`
- **Producer:** human-maintained (reviewed)
- **Consumer:** dominance analysis + audit guardrails
- **Schema:**
  - `version: int`
  - `evidence: { "<evidence_id>": { "risk": "low"|"med"|"high", "owner": str, "rationale": str } }`
- **Determinism:** stable ordering by `evidence_id`
- **Update rule:** review-required; changes treated as semantic

#### `out/test_obsolescence_report.json`
- **Producer:** `gabion check --emit-test-obsolescence`
- **Consumer:** CI/reporting + optional gating audit
- **Schema (current):**
  - `version: 3`
  - `generated_by_spec_id: str`
  - `generated_by_spec: { ...normalized ProjectionSpec... }`
  - `summary: { "redundant_by_evidence": int, "equivalent_witness": int, "obsolete_candidate": int, "unmapped": int }`
  - `candidates: [ { "test_id": str,
                    "class": "redundant_by_evidence"|"equivalent_witness"|"obsolete_candidate"|"unmapped",
                    "dominators": [str],
                    "reason": { "evidence": [str], "equivalence_class_size"?: int, "guardrail"?: str, "guardrail_evidence"?: [str], "status"?: str, "opaque_evidence"?: [str] } } ]`
- **Determinism:** stable ordering by `class` then `test_id`.

#### `out/test_obsolescence_report.md`
- Human-readable companion to the JSON, suitable for PR artifacts.

#### `baselines/test_obsolescence_baseline.json`
- **Producer:** `gabion check --write-test-obsolescence-baseline`
- **Consumer:** `gabion check --emit-test-obsolescence-delta`
- **Schema (current):**
  - `version: 1`
  - `summary: { redundant_by_evidence, equivalent_witness, obsolete_candidate, unmapped }`
  - `tests: [ { "test_id": str, "class": str } ]`
  - `evidence_index: [ { "key": { ...EvidenceKey... }, "display": str, "witness_count": int } ]`
  - `opaque_evidence_count: int`
  - `generated_by_spec_id`, `generated_by_spec`
- **Determinism:** tests sorted by `test_id`; evidence entries sorted by EvidenceKey identity.

#### `out/test_obsolescence_delta.json`
- **Producer:** `gabion check --emit-test-obsolescence-delta`
- **Consumer:** CI/reporting + review tooling (advisory, no gate yet)
- **Schema (current):**
  - `version: 1`
  - `baseline: { "path": str, "generated_by_spec_id": str, "generated_by_spec": {...} }`
  - `current: { "generated_by_spec_id": str, "generated_by_spec": {...} }`
  - `summary: { counts: { baseline, current, delta }, tests: {...}, evidence_keys: {...}, opaque_evidence: {...} }`
  - `tests: { added, removed, changed_class }`
  - `evidence_keys: { added, removed, changed }`
  - `generated_by_spec_id`, `generated_by_spec`
- **Determinism:** lists sorted by `test_id` and EvidenceKey identity.

#### `out/test_obsolescence_delta.md`
- Human-readable companion to the JSON, grouped deterministically.

### Optional / planned artifacts (not yet implemented)

#### `out/test_branch_coverage.json`
- **Producer:** coverage collector (future)
- **Consumer:** behavioral tie-breakers (future)
- **Notes:** Secondary signal only; must not override evidence-first dominance.

#### `out/test_line_coverage.json`
- **Producer:** coverage collector (future)
- **Consumer:** behavioral tie-breakers (future)

### Provenance (planned)
Provenance fields (repo revision, tool versions, config knobs) are not yet emitted.
If/when added, they must be deterministic and explicit.

---

## Admissibility

- **Admissible:**
  - Introducing Evidence IDs and mapping tests to them.
  - Merging redundant tests into parameterized forms if evidence coverage is preserved.
  - Removing tests classified as obsolete candidates **after review**.
- **Inadmissible:**
  - Treating line/branch novelty as sufficient evidence of value.
  - Removing the last test covering a `high` risk evidence ID.
  - Allowing new tests to land without either evidence mapping or explicit “unmapped” accounting (policy-configurable).
- **Ambiguity policy:** unmapped tests are allowed but surfaced; classification is conservative when evidence intent is unknown.
- **Non-explosion policy:** contradictions (e.g., evidence tags not in registry, inconsistent IDs) are reported and fail audits rather than silently normalized.

---

## Checks as Lemmas

- **Lemma L1 (discharges F1):** extraction script produces `test_evidence.json` and lists unmapped tests.
- **Lemma L2 (discharges F2):** dominance analysis computes strict evidence dominance and emits candidate classes (`redundant_by_evidence`, `equivalent_witness`, `obsolete_candidate`, `unmapped`).
- **Lemma L3 (discharges F3, future):** report highlights branch/line-only contributions without evidence.
- **Lemma L4 (discharges F4):** guardrail check prevents “last high-risk coverage” removal classification.
- **Lemma L5 (discharges F5, optional):** ratchet gate asserts evidence surface does not shrink vs baseline.

---

## Success Criteria

- [ ] A report is produced on CI for every PR, listing unmapped tests and redundancy classes.
- [ ] A dominated test can be identified with explicit dominators and a machine-checkable reason.
- [ ] High-risk evidence cannot become uncovered without explicit audit failure.
- [ ] The repo can choose (by configuration) whether to enforce “no new unmapped tests.”

---

## Failure Modes and Diagnostics

- **FM1:** Evidence tags malformed/unknown → inspect `test_evidence.json` extraction warnings; check Evidence ID naming.
- **FM2:** Dominance report unstable across runs → check determinism rules (ordering, canonical arc encoding).
- **FM3:** Too many “unmapped” tests → adopt gradual tagging: require mapping only for new/modified tests first.
- **FM4:** Branch coverage noisy (e.g., debug/log) → rely on evidence-first classification; branch novelty remains secondary.
- **FM5:** Guardrail blocks many deletions → adjust risk registry (overuse of `high`) or split evidence IDs more granularly.

---

## Commands

```bash
# 1) Extract test evidence (current carrier)
mise exec -- python -m scripts.extract_test_evidence --tests tests/ --out out/test_evidence.json

# 2) Emit test evidence suggestions (projection)
mise exec -- python -m gabion check --emit-test-evidence-suggestions

# 3) Emit obsolescence report (projection)
mise exec -- python -m gabion check --emit-test-obsolescence
```

---

## Appendix A: Canonical Template (Authoritative)

This document conforms to the canonical `in_step` template defined in `in/in-28.md`.
That template remains authoritative for structure, required sections, and frontmatter.

## Appendix B: Structural self-audit

### Notion registry

1. Evidence ID
2. Evidence surface
3. Dominance
4. Obsolete candidate
5. Branch-irrelevance smell
6. Risk guardrail
7. Ratchet gate
8. Report artifacts

### H₀–H₃ organizational interpretation

* **H₀:** A reportable mapping from tests to named obligations.
* **H₁:** Dominance as a dependency graph over tests via evidence inclusion.
* **H₂:** Guardrails as a cohomology-like obstruction: “cannot remove last high-risk witness.”
* **H₃:** The test suite as a semantic basis whose generators (tests) can be minimized without losing obligations.

### 3×3×3 orthogonal implication braid (compressed)

* **(Evidence × Behavior × Risk)**

  * Evidence dominates behavior; risk constrains removals.
* **(Artifacts × Audits × Gates)**

  * Artifacts carry claims; audits validate; gates enforce (optionally).
* **(Human intent × Machine extraction × Review)**

  * Intent is named (Evidence IDs), extraction is deterministic, review decides action.

---

## Appendix C: Evidence ID conventions (recommended)

* Current evidence IDs use the `E:` prefix with a structured namespace:

  * `E:<domain>/<name>` for human-curated IDs (e.g., `E:bundle/alias_invariance`)
  * `E:<domain>/<name>::<path>::<qual>::<paramset>` for graph-anchored IDs
    (e.g., `E:decision_surface/direct::core.py::pkg.core.decide::flag`)
* IDs are stable; rename only with a migration note and `doc_revision` bump if semantics change.
* Canonical identity is the EvidenceKey; `display` is a rendering of that key.
