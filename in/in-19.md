---
doc_revision: 1
reader_reintern: "Reader-only: re-intern if doc_revision changed since you last read this doc."
doc_id: in_19
doc_role: inbox
doc_scope:
  - repo
  - inbox
doc_authority: informative
doc_owner: maintainer
doc_requires:
doc_reviewed_as_of:
doc_review_notes:
doc_change_protocol: "POLICY_SEED.md §6"
doc_erasure:
  - formatting
  - typos
---
# in-19: Dependent-Type-Aware Synthesis and Structural Index Extraction

## Problem

Gabion currently emits structural decompositions (e.g., `FactorizationTree`) without encoding relationships between bundle fields or tree components. While useful for basic refactoring, this limits Gabion’s ability to participate in verified or dependent-type systems such as Agda, where **invariants across fields** must be made explicit in the type.

Many bundle structures imply internal relationships (e.g., length equality, ordering, alignment), but these are currently lost during factorization. As a result, synthesis output cannot capture the full semantic intent of the original structure and must be post-edited or re-proved manually.

## Goals

* Extract index-relevant structural properties from bundles or factorization trees.
* Allow grammars to emit propositions about these invariants.
* Emit dependent types (e.g., `Vec A n`, `SortedList n`) where warranted.
* Make these propositions re-usable for type-level verification, refactor safety checks, or test generation.

## Proposed Approach

1. **Extend `PartitionGrammar` with Invariant Emitters**

   ```python
   def emit_invariants(self, node: T) -> List[Proposition]
   ```

   * Each proposition describes a relationship between subparts.
   * E.g., “child_0.length == child_1.length”, or “leaf labels are sorted”.

2. **Introduce a Lightweight Proposition Model**

   ```python
   class Proposition:
       name: str
       terms: List[str]  # Named slots in the grammar tree
       form: str         # e.g., 'Equal', 'LessThan', 'DependentIndex'
   ```

   * Enables backends to interpret into Agda, Coq, Python assertions, or documentation.

3. **Agda Type Synthesis with Indexed Constructors**

   * Allow emitters to generate terms like:

     ```agda
     vec : Vec A n
     sorted : Sorted vec
     ```
   * Enable type checking of synthesized refactors under these constraints.

4. **Test and Fuzzing Hooks**

   * Use emitted propositions to generate property-based tests.
   * Surface invariants as hypothesis clauses for LLM-driven completions.

## Example

Code:

```python
def pairwise_zip(a, b):
    assert len(a) == len(b)
    return [(x, y) for x, y in zip(a, b)]
```

Gabion emits:

```json
{
  "bundle": "zip_input",
  "fields": ["a", "b"],
  "invariants": [
    {"form": "Equal", "terms": ["a.length", "b.length"]}
  ]
}
```

Agda output:

```agda
zipVec : ∀ {A B n} → Vec A n → Vec B n → Vec (A × B) n
```

## Dependencies

* Requires invariant emitters in grammar passes
* Proposition model for invariant translation
* Agda backend support for indexed terms

## Acceptance Criteria

* At least one grammar outputs an invariant proposition
* CLI outputs invariant-enriched bundle structure (JSON + Agda)
* Synthesized Agda term includes dependent type with extracted index
* Optional test synthesis can leverage invariant clauses

---

Proposed by: dependent structure audit
Related: in-3 (bundling), in-17 (reusable lemmas), in-18 (algebraic control surfaces)
Status: draft
